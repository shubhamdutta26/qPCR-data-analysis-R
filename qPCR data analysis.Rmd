---
title: "Real time qPCR data analysis using R"
author: "Shubham Dutta"
date: "11/24/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<br>


### Introduction

I will be using the [Tidyverse](https://www.tidyverse.org/) package in R to analyse and plot a simple RT-qPCR experiment data. In this experiment, I have ectopically-expressed two proteins namely NKG2A and NKG2C (along with their binding partner CD94) in HEK293 cells. I want to assess the expression status of these genes in the HEK293 cells relative to GAPDH using the $\Delta$$\Delta$C~T~ method. The experiment was run in a [C1000 Touch Thermal Cycler](https://www.bio-rad.com/en-us/product/c1000-touch-thermal-cycler?ID=LGTW9415) instrument.

<br>


### The $\Delta$$\Delta$C~T~ method for gene expression analysis

The $\Delta$$\Delta$C~T~ method (also known as the 2^–∆∆C~T~^ method) is a simple formula used to calculate the relative fold gene expression of samples when performing RT-qPCR. The method was developed by Kenneth Livak and Thomas Schmittgen in 2001 and is widely used ([Livak & Schmittgen, 2001](https://doi.org/10.1006/meth.2001.1262)).

C~T~ (or C~Q~) stands for the Cycle Threshold (or Cycle Quantification) of a sample. This is given after the qPCR reaction by the software. Simply put, it is the cycle number where the fluorescence generated by the PCR product is distinguishable from the background fluorescence signal.

*The symbol $\Delta$ (Delta) is a mathematical term used to describe the difference between two values.*

Let’s see how we can calculate the $\Delta$$\Delta$C~T~:

> $\Delta$$\Delta$C~T~ = $\Delta$C~T~ (treated sample) – $\Delta$C~T~ (untreated sample)

Essentially, $\Delta$$\Delta$C~T~ is the difference between the $\Delta$C~T~ values of the treated/experimental sample and the untreated/control sample. But what does $\Delta$C~T~ refer to?

> $\Delta$C~T~ = C~T~ (gene of interest) – C~T~ (housekeeping gene)

Basically, $\Delta$C~T~ is the difference in $\Delta$C~T~ values for your gene of interest and your housekeeping gene for a given sample. This is to essentially normalise the gene of interest to a gene which is not affected by your experiment.

Finally, to work out the fold gene expression (F~C~) we need to do 2 to the power of negative $\Delta$$\Delta$C~T~:

> F~C~ = 2^(–$\Delta$$\Delta$C~T~)^

Let us move to the fun part now!
<br><br>

### Data Analysis

<br>

#### Install and load Tidyverse package

We will use the [Tidyverse](https://www.tidyverse.org/) package for the data analysis.

Install the Tidyverse package:<br><br>
`install.packages("tidyverse")`
<br><br>
Load the Tidyverse package into R Studio environment:
```{r error=FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
```

<br>

#### Importing the data
Now we will import the qPCR data (a csv document in this case) into the R Studio environment using the `read.csv` function and store it as a dataframe (df) called **qpcr**.<br>
```{r}
qpcr <- read.csv("qPCR_HEKs_OE_NKG2A-C_human.csv", stringsAsFactors = FALSE)
tibble(qpcr)
```
There are 15 columns (variables) in our data but we only need a some them for our data analysis. Therefore, using the `select` function we will extract the columns we need and store them in a new df called **tidyData**.
```{r}
tidyData <- qpcr %>% select(Target:Cq, -Content)
glimpse(tidyData)
```
Lets look at the 4 columns now:

* **Target**: This variable stores the different target genes which in this case are GAPDH, NKG2A, NKG2B, and CD94.
* **Sample**: These are different biological replicates. There are 5 replicates. There are no technical replicates for this experiment.
* **Biological.Set.Name**: This variable stores the three different conditions. HEK cells are transfected with empty vector (empty vector), NKG2A/ CD94 (pcDNA-NKG2A), and NKG2C/ CD94 (pcDNA-NKG2C).
* **C~q~**: The C~q~ (or C~T~) value for each condition. From here on till the end I will be using C~T~ and C~Q~ interchangeably.

<br>

#### Calculate $\Delta$C~T~
The $\Delta$C~T~ is the differnce between the C~T~ of the housekeeping gene and the target gene.
To calculate $\Delta$C~T~ we need to determine the average C~T~ of GAPDH for three conditions (empty vector, pcDNA-NKG2A, and pcDNA-NKG2C).



We will use the `filter` function to extract and store the C~T~ values of GAPDH in a new df called **gapdh_only**. Then we will use the `group_by`, `summarise`, and `mean()` functions to calculate mean C~T~s for the three conditions and store the values in another df called **avg_gapdh**.


`%>%` is called the pipe operator. This special operational function available under the [magrittr](https://cran.r-project.org/web/packages/magrittr/vignettes/magrittr.html) and [dplyr](https://dplyr.tidyverse.org/) package (basically developed under magrittr), which allows us to pass the result of one function/argument to the other one in sequence.
```{r}
gapdh_only <- tidyData %>% filter(Target == "GAPDH")
avg_gapdh <- gapdh_only %>% group_by(Biological.Set.Name) %>% summarize(ref_cq = mean(Cq))
avg_gapdh
```
We have stored the mean GAPDH C~T~ value as *ref_cq*.<br>
We will subtract the *ref_cq* from the *Cq* of the other target genes. Let's take *NKG2A* as an example and see a step-by-step process:

First, we will extract the NKG2A target gene data for all the conditions and store it in *nkg2a_only* df.
```{r}
nkg2a_only <- tidyData %>% filter(Target == "NKG2A")
head(nkg2a_only)
```
Second, we will join the *avg_gapdh* & *nkg2a_only* dfs using `left_join`:
```{r}
nkg2a_gapdh <- left_join(nkg2a_only, avg_gapdh, by = "Biological.Set.Name")
head(nkg2a_gapdh)
```
Finally, we will calculate the $\Delta$C~T~ for the NKG2A dataset and store the values in *nkg2a_gapdh* df.
The `mutate` function basically calculates *del_cq* values and adds a new column (variable) to the existing df.
```{r}
nkg2a_gapdh <- nkg2a_gapdh %>% mutate(del_cq = ref_cq - Cq)
head(nkg2a_gapdh)
```

Please feel free to use the dataset to calculate the $\Delta$C~T~ for NKG2C and CD94 genes.

<br>

#### Calculate $\Delta$$\Delta$C~T~
The $\Delta$$\Delta$C~T~ is the difference between the $\Delta$C~T~ values of  treated/experimental sample and the untreated/control sample.

First, we calculate mean C~T~ for "empty vector" from *nkg2a_gapdh* df and store it in the **nkg2a_empty** variable.
```{r}
nkg2a_empty <- nkg2a_gapdh %>% filter(Biological.Set.Name == "empty vector") %>% summarise(mean_empty = mean(del_cq)) %>% pull(mean_empty)
nkg2a_empty
```
Second, we calculate the $\Delta$$\Delta$C~T~ values and append the values to *nkg2a_gapdh* df.
```{r}
nkg2a_gapdh <- nkg2a_gapdh %>% mutate(del_del_cq = del_cq - nkg2a_empty)
head(nkg2a_gapdh)
```
Finally, we can calculate the fold change gene expression for each condition using the F~C~ formula above.
```{r}
nkg2a_geneExp <- nkg2a_gapdh %>% mutate(geneExp = 2^(del_del_cq))
head(nkg2a_geneExp)
```
Please feel free to use the dataset to calculate the $\Delta$$\Delta$C~T~ for NKG2C and CD94 genes.

<br>

Lets move on to the plotting the data.
```{r echo=FALSE, fig.show='hide'}
### NKG2C start

# Get all NKG2C values for all three conditions

nkg2c_only <- tidyData %>% filter(Target == "NKG2C")

# join avg_gapdh with nkg2c_only to a new df named "nkg2c_gapdh"

nkg2c_gapdh <- left_join(nkg2c_only, avg_gapdh, by = "Biological.Set.Name")

# calculate del_cq for nkg2c

nkg2c_gapdh <- nkg2c_gapdh %>% mutate(del_cq = ref_cq - Cq)

# Extract empty vector information from nkg2c_gapdh

nkg2c_empty <- nkg2c_gapdh %>% filter(Biological.Set.Name == "empty vector") %>% summarise(mean_empty = mean(del_cq)) %>% pull(mean_empty)

#Calculate del_del_cq for nkg2c_gapdh

nkg2c_gapdh <- nkg2c_gapdh %>% mutate(del_del_cq = del_cq - nkg2c_empty)

# Calculate gene expression data for nkg2c data

nkg2c_geneExp <- nkg2c_gapdh %>% mutate(geneExp = 2^(del_del_cq))

# Calculte statistical parameters

nkg2c_geneExp_final <- nkg2c_geneExp %>% group_by(Biological.Set.Name) %>% summarise(mean_geneExp = mean(geneExp), sd_geneExp = sd(geneExp)) %>% mutate(Target = c("NKG2C", "NKG2C", "NKG2C"))

# Plot
nkg2c_plot <- ggplot(nkg2c_geneExp_final, aes(x = Biological.Set.Name, y = mean_geneExp))+
  geom_bar(stat = "identity")+
  geom_errorbar(aes(ymin = mean_geneExp - sd_geneExp, ymax = mean_geneExp + sd_geneExp), width=.2)
nkg2c_plot

### NKG2C end




### CD94 start

# Get all CD94 values for all three conditions

cd94_only <- tidyData %>% filter(Target == "CD94")

# join avg_gapdh with cd94_only to a new df named "cd94_gapdh"

cd94_gapdh <- left_join(cd94_only, avg_gapdh, by = "Biological.Set.Name")

# calculate del_cq for cd94

cd94_gapdh <- cd94_gapdh %>% mutate(del_cq = ref_cq - Cq)

# Extract empty vector information from cd94_gapdh

cd94_empty <- cd94_gapdh %>% filter(Biological.Set.Name == "empty vector") %>% summarise(mean_empty = mean(del_cq)) %>% pull(mean_empty)

#Calculate del_del_cq for cd94_gapdh

cd94_gapdh <- cd94_gapdh %>% mutate(del_del_cq = del_cq - cd94_empty)

# Calculate gene expression data for cd94 data

cd94_geneExp <- cd94_gapdh %>% mutate(geneExp = 2^(del_del_cq))

# Calculte statistical parameters

cd94_geneExp_final <- cd94_geneExp %>% group_by(Biological.Set.Name) %>% summarise(mean_geneExp = mean(geneExp), sd_geneExp = sd(geneExp)) %>% mutate(Target = c("CD94", "CD94", "CD94"))

# Plot
cd94_plot <- ggplot(cd94_geneExp_final, aes(x = Biological.Set.Name, y = mean_geneExp))+
  geom_bar(stat = "identity")+
  geom_errorbar(aes(ymin = mean_geneExp - sd_geneExp, ymax = mean_geneExp + sd_geneExp), width=.2)
cd94_plot

### CD94 end
```

### Data Plotting
## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
